<!doctype html>
<html>
  <head>
    <title>webgl</title>
    <style type="text/css">
      body { margin: 0; background-color: #000000; overflow: hidden; }
    </style>
  </head>
  <body>
    <canvas id="canvas_spec" width="8192" height="400"></canvas>
    <div id="mods">
      <a href="phuture_sounds.mod"/>phuture_sounds</a>
      <a href="mindkick.mod"/>mindkick</a>
      <a href="cyberm00n.mod"/>cyberm00n</a>
      <a href="psimon_-_queen.mod"/>psimon_-_queen</a>
      <a href="speed_chase.mod"/>speed_chase</a>
      <a href="beat_it.mod"/>beat_it</a>
      <a href="ipanema.mod"/>ipanema</a>
      <a href="careless_whisper.mod"/>careless_whisper</a>
      <a href="tocatta.mod"/>tocatta</a>
      <a href="sonata.mod"/>sonata</a>
      <a href="monday.mod"/>monday</a>
      <a href="hendrix.mod"/>hendrix</a>
    </div>
    <script type="text/javascript" src="modfile.js"></script>
    <script type="text/javascript" src="modplayer.js"></script>
    <script type="text/javascript" src="sink.js"></script>
    <script type="text/javascript" src="fft.js"></script>
    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function () {

        modPlayerSet = false;

        canvas5 = document.getElementById("canvas_spec");
        context5 = canvas5.getContext('2d');
        context5.strokeStyle = "#FFFFFF";
        context5.lineWidth = 2;

        channels = 2;
        fbLength = 1024 * 8;
        rate     = 44100;
        fft = new FFT(fbLength, rate);

        function write_samples (samples) {
          var width = 4;
          length = samples.length / channels;
          signal = samples;
          /*
          new Float32Array(length);
          for (i = 0; i < length; i++ ) {
            if (channels == 2) {
              // merge channels into a stereo-mix mono signal
              signal[i] = (samples[2*i] + samples[2*i+1]) / 2;
            } else { // assume no more than 2 channels of data
              signal[i] = samples[i];
            }
          }
          */
          fft.forward(signal);
          context5.fillStyle = "#"+((1<<24)*Math.random()|0).toString(16); //"rgba(0, 0, 0, 0.01)";
          context5.save();
          context5.translate(-5, -2);
          context5.globalAlpha = 0.01;
          context5.drawImage(canvas5, 0, 0);
          context5.restore();

          for (i = 0; i < 512; i++ ) {
            magnitude = fft.spectrum[i] * 3000;
            if (magnitude > 375) {
              magnitude = 375;
            }
            context5.fillRect(i * width, canvas5.height, width+1, -magnitude);
          }
        }

        sink = Sink(function(buffer) {
          if (modPlayerSet) {
            written = modPlayer.getSamples(buffer, buffer.length);
            write_samples(buffer);
            console.log(written);
            if (written == 0) {
              play_mod(random_mod_href());
            }
          }
        });
        
        loading = false;

        function play_mod(href) {
          if (loading) {
          } else {
            modPlayerSet = false;
            loading = true;
            fetch = new XMLHttpRequest();
            fetch.open('GET', 
              href
            );
            fetch.overrideMimeType("text/plain; charset=x-user-defined");
            fetch.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                t = this.responseText || "" ;
                ff = [];
                mx = t.length;
                scc = String.fromCharCode;
                for (z = 0; z < mx; z++) {
                  ff[z] = scc(t.charCodeAt(z) & 255);
                }
                binString = ff.join("");
                modFile = new ModFile(binString);
                modPlayer = new ModPlayer(modFile, rate);
                modPlayerSet = true;
                loading = false;
                context5.clearRect(0,0, fbLength, canvas5.height);
              }
            }
            fetch.send();
          }
        }
        mods = document.getElementById("mods").getElementsByTagName("a");
        for (i=0; i<mods.length; i++) {
          mods[i].onclick = function () {
            play_mod(this.href);
            return false;
          };
        }
        function random_mod_href() {
          return mods[Math.floor(Math.random() * mods.length)].href;
        };
        play_mod(random_mod_href());
      });
    </script>
  </body>
</html>
