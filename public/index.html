<!doctype html>
<html>
  <head>
    <title>webgl</title>
    <style type="text/css">
      body { margin: 0; background-color: #000000; overflow: hidden; }
    </style>
  </head>
  <body>
    <canvas id="canvas_spec" width="8192" height="400" style="background-color:orange;"></canvas>
    <div id="mods">
      <a href="phuture_sounds.mod"/>phuture_sounds</a>
      <a href="mindkick.mod"/>mindkick</a>
      <a href="cyberm00n.mod"/>cyberm00n</a>
      <a href="psimon_-_queen.mod"/>psimon_-_queen</a>
      <a href="speed_chase.mod"/>speed_chase</a>
      <a href="beat_it.mod"/>beat_it</a>
      <a href="ipanema.mod"/>ipanema</a>
    </div>
    <script type="text/javascript" src="modfile.js"></script>
    <script type="text/javascript" src="modplayer.js"></script>
    <script type="text/javascript" src="sink.js"></script>
    <script type="text/javascript" src="fft.js"></script>
    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function () {
        time = 0;

        modPlayerSet = false;
        is_audio_ready = false;

        canvas5 = document.getElementById("canvas_spec");
        context5 = canvas5.getContext('2d');
        context5.strokeStyle = "#FFFFFF";
        context5.lineWidth = 2;

        channels = 2;
        fbLength = 1024 * 4;
        rate     = 44100;
        fft = new FFT(fbLength / channels, rate);
        audio_b = new Float32Array();

        width = 5;

        function write_samples (samples) {
          length = samples.length / channels;
          console.log(length);
          signal = new Float32Array(length);
          for (i = 0; i < length; i++ ) {
            if (channels == 2) {
              // merge channels into a stereo-mix mono signal
              signal[i] = (samples[2*i] + samples[2*i+1]) / 2;
              console.log(samples[i]);
            } else { // assume no more than 2 channels of data
              signal[i] = samples[i];
            }
          }
          fft.forward(signal);
          context5.clearRect(0,0, fbLength, canvas5.height);
          for (i = 0; i < 256; i++ ) {
            context5.fillStyle = "rgba(0,0,0, 0.1)";
            magnitude = fft.spectrum[i] * 2000;
            if (i == 3 && magnitude > 140) {
              context5.fillStyle = "rgba(200,0,0, 0.5)";
            }
            if (magnitude > 5) {
              context5.fillRect(i * width, canvas5.height, width+1, -magnitude);
            }
          }
        }

        count = 0;
        now_a = last_a = now_v = last_v = new Date().getTime();

        //dynamicAudio = new DynamicAudio({'swf': 'dynamicaudio.swf'});
        sink = Sink(function(buffer) {
          if (modPlayerSet) {
            //sample_length = parseInt(rate * channels * ((dtt) / 1000));
            //samples = (modPlayer.getSamples(sample_length));
            modPlayer.getSamples(buffer, buffer.length);
            audio_b = audio_b.concat(buffer);
            is_audio_ready = true;
          }
        });
        
        //sink.ringBuffer = new Float32Array(fbLength);


        loading = false;

        function play_mod(href) {
          if (loading) {
          } else {
            loading = true;
            fetch = new XMLHttpRequest();
            fetch.open('GET', 
              href
            );
            fetch.overrideMimeType("text/plain; charset=x-user-defined");
            fetch.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                /* munge response into a binary string */
                t = this.responseText || "" ;
                ff = [];
                mx = t.length;
                scc = String.fromCharCode;
                for (z = 0; z < mx; z++) {
                  ff[z] = scc(t.charCodeAt(z) & 255);
                }
                binString = ff.join("");
                modFile = new ModFile(binString);
                modPlayer = new ModPlayer(modFile, rate);
                modPlayerSet = true;
                loading = false;
              }
            }
            fetch.send();
          }
        }
        mods = document.getElementById("mods").getElementsByTagName("a");
        for (i=0; i<mods.length; i++) {
          mods[i].onclick = function () {
            play_mod(this.href);
            return false;
          };
        }
        function random_mod_href() {
          return mods[Math.floor(Math.random() * mods.length)].href;
        };
        play_mod(random_mod_href());
        /*
        (function pump_audio() {
          now_a = new Date().getTime();
          dtt = now_a - last_a;
          last_a = now_a;
          if (modPlayerSet) {
            sample_length = parseInt(rate * channels * ((dtt) / 1000));
            samples = (modPlayer.getSamples(sample_length));
            //sink.writeMode = "sync";
            //console.log(sink);
            sink.writeBufferSync(samples);
            //dynamicAudio.write(samples);
            audio_b = audio_b.concat(samples);
            is_audio_ready = true;
            if (samples.length == 0) {
              play_mod(random_mod_href());
            }
          }
          window.setTimeout(pump_audio, 1000);
        })();
        */
        (function render_and_vsync(timestamp) {
          if (timestamp) {
            now_v = timestamp;
            
            dt = now_v - last_v;

            time += dt;
            last_v = now_v;

            if (is_audio_ready) {
              /*
              sl = (rate * channels * (dt / 1000))
              chumped = audio_b.splice(0, sl);
              fill = new Float32Array(fbLength);
              for (i=0; i<chumped.length; i++) {
                fill[i] = chumped[i];
              }
              write_samples(fill);
              */
              write_samples(audio_b.splice(0, fbLength));
              //console.log(sink.ringBuffer);
            }

          }
          (function vsync() {
            return window.requestAnimationFrame || 
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame || 
            window.oRequestAnimationFrame || 
            window.msRequestAnimationFrame || 
            function(callback, element){
              window.setTimeout(callback, 1000 / 60);
            };
          })()(render_and_vsync);
        })();
      });
    </script>
  </body>
</html>
